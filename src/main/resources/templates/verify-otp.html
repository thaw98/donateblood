<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<link th:href="@{/css/login.css}" rel="stylesheet" type="text/css">
<link th:href="@{/css/style.css}" rel="stylesheet" type="text/css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">

<head th:replace="~{header}"></head>
<body>
<div class="container d-flex justify-content-center align-items-center vh-100">
    <div class="card p-4 shadow-sm" style="width: 400px;">
        <div class="card-body">
            <h3 class="card-title text-center mb-3">üîë Verify OTP</h3>
            <p class="text-center text-muted mb-4">Check your Gmail and enter the OTP code below</p>

            <!-- Server-side message -->
            <div th:if="${msg}" class="alert alert-warning" th:text="${msg}"></div>

            <form th:action="@{/auth/verify-otp}" method="post" onsubmit="return validateOTPForm()">
                <!-- Email (readonly) -->
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" name="email" id="email" class="form-control" th:value="${email}" readonly>
                </div>

                <!-- OTP -->
                <div class="mb-3">
                    <label for="otp" class="form-label">OTP <span class="text-danger">*</span></label>
                    <input type="text" name="otp" id="otp" class="form-control" placeholder="Enter OTP"
                           oninput="validateFieldInstant('otp','otpError','OTP is required')" required>
                    <small class="text-danger" id="otpError"></small>
                </div>

                <!-- Countdown Timer -->
                <div class="mb-3 text-center">
                    <span id="timer" class="badge fs-6 p-2"></span>
                </div>

                <button type="submit" id="verifyBtn" class="btn btn-primary w-100 mb-2">
                    <i class="fas fa-check-circle me-2"></i> Verify OTP
                </button>
            </form>

            <!-- Resend OTP Button -->
            <div class="text-center">
                <button id="resendBtn" class="btn btn-outline-secondary w-100 fade-in" onclick="resendOTP()" disabled>
                    üîÅ Resend OTP
                </button>
                <p class="mt-3"><a th:href="@{/login}" class="text-decoration-none">&larr; Back to Login</a></p>
            </div>
        </div>
    </div>
</div>

<!-- FontAwesome -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<style>
/* Fade-in effect for Resend OTP button */
.fade-in {
    opacity: 0.3;
    transition: opacity 0.5s ease-in-out;
}
.fade-in.active {
    opacity: 1;
}

/* Timer colors */
#timer.normal { background-color: #dc3545; color: #fff; }  /* Red */
#timer.warning { background-color: #ffc107; color: #000; } /* Yellow */
</style>

<script>
// Timer variables
let countdown;
const otpDuration = 1 * 60; // 1 minute
let remainingTime = otpDuration;

// Show error once
function showErrorOnce(element, message) {
    element.textContent = message;
    setTimeout(() => { element.textContent = ""; }, 5000);
}

// Instant validation
function validateFieldInstant(fieldId, errorId, message) {
    const value = document.getElementById(fieldId).value.trim();
    if (!value) showErrorOnce(document.getElementById(errorId), message);
}

// Form validation
function validateOTPForm() {
    const otp = document.getElementById("otp").value.trim();
    if (!otp) {
        showErrorOnce(document.getElementById("otpError"), "OTP is required");
        return false;
    }
    if (remainingTime <= 0) {
        showErrorOnce(document.getElementById("otpError"), "OTP has expired. Please resend.");
        return false;
    }
    return true;
}

// Start countdown
function startCountdown() {
    clearInterval(countdown);
    remainingTime = otpDuration;
    updateTimerDisplay();

    const resendBtn = document.getElementById("resendBtn");

    // Reset buttons
    document.getElementById("verifyBtn").disabled = false;
    resendBtn.disabled = true;
    resendBtn.classList.remove("active");

    countdown = setInterval(() => {
        remainingTime--;
        updateTimerDisplay();

        if (remainingTime <= 0) {
            clearInterval(countdown);
            document.getElementById("verifyBtn").disabled = true;

            // Enable resend button with fade-in effect
            resendBtn.disabled = false;
            resendBtn.classList.add("active");
        }
    }, 1000);
}

// Update timer display with color change
function updateTimerDisplay() {
    const minutes = Math.floor(remainingTime / 60);
    const seconds = remainingTime % 60;
    const timerEl = document.getElementById("timer");

    timerEl.textContent = `OTP expires in ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

    // Change color when <1 min
    if (remainingTime <= 60) {
        timerEl.classList.remove("normal");
        timerEl.classList.add("warning");
    } else {
        timerEl.classList.remove("warning");
        timerEl.classList.add("normal");
    }
}

// Resend OTP
function resendOTP() {
    const resendBtn = document.getElementById("resendBtn");
    fetch('/auth/resend-otp?email=' + encodeURIComponent(document.getElementById("email").value), {
        method: 'POST'
    })
    .then(response => response.text())
    .then(msg => {
        alert(msg);
        startCountdown(); // Restart countdown
    })
    .catch(error => console.error('Error:', error));
}

// Start timer on page load
window.onload = startCountdown;
</script>
</body>
</html>
