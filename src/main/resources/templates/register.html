<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<link th:href="@{/css/register.css}" rel="stylesheet" type="text/css"> 
<link th:href="@{/css/style.css}" rel="stylesheet" type="text/css"> 
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<head th:replace="~{header}"></head>

<body>
<div class="container">
    <div class="registration-container">
        <div class="form-header">
            <h2><span class="blood-drop">ðŸ©¸</span> Become a Blood Donor</h2>
            <p>Join our community of lifesavers. Your registration takes just a few minutes.</p>
        </div>

        <form th:action="@{/register}" th:object="${userObj}" method="post" enctype="multipart/form-data" class="form-body" onsubmit="return validateForm()">

            <!-- Profile Photo -->
            <div class="mb-4 text-center">
                <label for="filePart" class="form-label d-block fw-bold">Profile Photo</label>
                <div class="profile-upload">
                    <img id="previewImage" 
                         src="https://cdn-icons-png.flaticon.com/512/149/149071.png" 
                         alt="Profile Preview" 
                         class="preview-img">
                    <div class="camera-overlay" onclick="document.getElementById('filePart').click()">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <input type="file" id="filePart" th:field="*{filePart}" accept="image/*" style="display: none;">
            </div>

            <!-- Row 1: Name and Email -->
            <div class="form-row">
                <div class="form-group">
                    <label for="username" class="form-label">Name<span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="username" th:field="*{username}" placeholder="Enter your full name" oninput="validateFieldInstant('username','usernameError','Name is required')">
                    <small class="text-danger" id="usernameError"></small>
                </div>
                
                <div class="form-group">
                    <label for="email" class="form-label">Email<span class="text-danger">*</span></label>
                    <input type="email" class="form-control" id="email" th:field="*{email}" placeholder="like...@gmail.com" oninput="validateFieldInstant('email','emailError','Enter a valid Gmail')">
                    <small class="text-danger" id="emailError"></small>
                </div>
            </div>

            <!-- Row 2: Phone and Blood Type -->
            <div class="form-row">
                <div class="form-group">
                    <label for="phone" class="form-label">Phone Number<span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="phone" th:field="*{phone}" placeholder="09xxxxxxxxx" maxlength="11"
                           oninput="restrictPhoneLength(this); validatePhoneInstant()">
                    <small class="text-danger" id="phoneError"></small>
                </div>
                
                <div class="form-group">
                    <label for="bloodType" class="form-label">Blood Type<span class="text-danger">*</span></label>
                    <select id="bloodType" th:field="*{bloodTypeId}" class="form-select">
                        <option value="" selected>Select Blood Type</option>
                        <option th:each="bt : ${bloodTypes}" 
                                th:value="${bt.id}" 
                                th:text="${bt.bloodType}">
                        </option>
                    </select>
                    <div class="invalid-feedback text-danger small"></div>
                </div>
            </div>
            
             <!-- Row 3: Gender and Date of Birth -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Gender<span class="text-danger">*</span></label>
                    <div class="gender-options">
                        <div class="gender-option">
                            <input type="radio" th:field="*{gender}" value="Male" id="male" onchange="validateGenderInstant()">
                            <label for="male">Male</label>
                        </div>
                        <div class="gender-option">
                            <input type="radio" th:field="*{gender}" value="Female" id="female" onchange="validateGenderInstant()">
                            <label for="female">Female</label>
                        </div>
                    </div>
                    <small class="text-danger" id="genderError"></small>
                </div>
                
                <div class="form-group">
                    <label for="dateofbirth" class="form-label">Date of Birth<span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="dateofbirth" th:field="*{dateofbirth}" onchange="validateDOBInstant()">
                    <small class="text-danger" id="dobError"></small>
                    <small id="dobFormatted" class="dob-info"></small>
                </div>
            </div>

            <!-- Row 4: Password and Confirm Password -->
            <div class="form-row">
                <div class="form-group">
                    <label for="password" class="form-label">Password<span class="text-danger">*</span></label>
                    <input type="password" class="form-control" th:field="*{password}" id="password" placeholder="Create a strong password" 
                           oninput="checkStrength(); validatePasswordMatchInstant(); validateFieldInstant('password','passwordError','Password is required')">
                    <div class="show-password">
                        <input type="checkbox" onclick="togglePassword('password')"> Show Password
                    </div>
                    <div class="strength-container">
                        <span id="strengthMsg"></span>
                        <div class="strength-bar">
                            <div id="strengthFill" class="strength-fill"></div>
                        </div>
                    </div>
                    <small class="text-danger" id="passwordError"></small>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword" class="form-label">Confirm Password<span class="text-danger">*</span></label>
                    <input type="password" class="form-control" th:field="*{confirmPassword}" id="confirmPassword" placeholder="Re-enter your password"
                           oninput="validatePasswordMatchInstant(); validateFieldInstant('confirmPassword','confirmPasswordError','Confirmation password is required')">
                    <div class="show-password">
                        <input type="checkbox" onclick="togglePassword('confirmPassword')"> Show Password
                    </div>
                    <small class="text-danger" id="confirmPasswordError"></small>
                </div>
            </div>

           

            <!-- Row 5: Address and Role -->
            
            <div class="form-group">
                    <label for="role" class="form-label">I want to register as a:<span class="text-danger">*</span></label>
                    <select class="form-select" id="role" th:field="*{role.id}" onchange="validateFieldInstant('role','roleError','Select your role')">
                        <option value="" disabled selected>Select your role</option>
                        <option th:each="r : ${roleList}" th:value="${r.id}" th:text="${r.role}"></option>
                    </select>
                    <small class="text-danger" id="roleError"></small>
                </div>
            
                <div class="form-group full-width">
                    <label for="address" class="form-label">Address<span class="text-danger">*</span></label>
                    <textarea class="form-control" th:field="*{address}" rows="3" id="address" placeholder="Sample: Yangon, Hlaing, Street No.10"
                              oninput="validateFieldInstant('address','addressError','Address is required')"></textarea>
                    <small class="text-danger" id="addressError"></small>
                </div>
                
                
            

            <button type="submit" class="btn btn-register">Complete Registration</button>
        </form>

        <div class="form-footer">
            <p>Already have an account? <a th:href="@{/login}" class="nav-link">Sign in here</a></p>
        </div>
    </div>
</div>

<script>
    // --- JS functions ---
    function showErrorOnce(element, message) {
        element.textContent = message;
        setTimeout(() => { element.textContent = ""; }, 5000);
    }

    function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        field.type = field.type === "password" ? "text" : "password";
    }

    document.addEventListener("DOMContentLoaded", function() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth()+1).padStart(2,'0');
        const dd = String(today.getDate()).padStart(2,'0');
        document.getElementById("dateofbirth").setAttribute("max", `${yyyy}-${mm}-${dd}`);
    });

    function checkStrength() {
        const password = document.getElementById("password").value;
        const strengthMsg = document.getElementById("strengthMsg");
        const strengthFill = document.getElementById("strengthFill");
        if(!password){ strengthMsg.textContent=""; strengthFill.style.width="0%"; return; }
        let strength=0;
        if(password.length>=6) strength++;
        if(/[A-Z]/.test(password)) strength++;
        if(/[a-z]/.test(password)) strength++;
        if(/[0-9]/.test(password)) strength++;
        if(/[^A-Za-z0-9]/.test(password)) strength++;
        let color="", msg="", width="";
        if(strength<=2){color="red"; msg="Weak ðŸ”´"; width="40%";}
        else if(strength<=4){color="orange"; msg="Medium ðŸŸ "; width="70%";}
        else{color="green"; msg="Strong ðŸŸ¢"; width="100%";}
        strengthFill.style.width=width;
        strengthFill.style.background=color;
        strengthMsg.textContent=msg;
        strengthMsg.style.color=color;
    }

    function validateFieldInstant(fieldId, errorId, message){
        const value = document.getElementById(fieldId)?.value?.trim();
        if(!value) showErrorOnce(document.getElementById(errorId), message);
    }

    function validatePasswordMatchInstant(){
        const password=document.getElementById("password").value;
        const confirm=document.getElementById("confirmPassword").value;
        if(password && confirm && password!==confirm)
            showErrorOnce(document.getElementById("passwordError"),"Passwords do not match");
    }

    function validateGenderInstant(){
        const male=document.querySelector("input[value='Male']").checked;
        const female=document.querySelector("input[value='Female']").checked;
        if(!male && !female) showErrorOnce(document.getElementById("genderError"),"Select your gender");
    }

    function validateDOBInstant(){
        const dob=document.getElementById("dateofbirth").value;
        const dobError=document.getElementById("dobError");
        const dobFormatted=document.getElementById("dobFormatted");
        if(!dob){ showErrorOnce(dobError,"Date of birth is required"); dobFormatted.textContent=""; return false;}
        const birthDate=new Date(dob); const today=new Date();
        if(birthDate>today){ showErrorOnce(dobError,"You cannot select a future date"); dobFormatted.textContent=""; return false;}
        let age=today.getFullYear()-birthDate.getFullYear();
        const monthDiff=today.getMonth()-birthDate.getMonth();
        const dayDiff=today.getDate()-birthDate.getDate();
        if(monthDiff<0 || (monthDiff===0 && dayDiff<0)) age--;
        dobFormatted.textContent=`Age: ${age} years`;
        return true;
    }

    function validatePhoneInstant(){
        const phone=document.getElementById("phone").value.trim();
        const phoneError=document.getElementById("phoneError");
        const phoneRegex=/^09\d{7,9}$/;
        if(!phone){ showErrorOnce(phoneError,"Phone number is required"); return false;}
        if(!phoneRegex.test(phone)){ showErrorOnce(phoneError,"Enter a valid phone number"); return false;}
        phoneError.textContent=""; return true;
    }

    function restrictPhoneLength(input){
        input.value=input.value.replace(/\D/g,'');
        if(input.value.length>11) input.value=input.value.slice(0,11);
    }

    document.getElementById('filePart').addEventListener('change', function(event){
        const file=event.target.files[0];
        if(file){
            const reader=new FileReader();
            reader.onload=function(e){ document.getElementById('previewImage').src=e.target.result; };
            reader.readAsDataURL(file);
        }
    });

    function validateForm(){
        let isValid=true;
        if(!document.getElementById("username").value.trim()){ showErrorOnce(document.getElementById("usernameError"),"Name is required"); isValid=false;}
        const email=document.getElementById("email").value.trim();
        const emailRegex=/^[a-zA-Z0-9._%+-]+@gmail\.com$/;
        if(!email || !emailRegex.test(email)){ showErrorOnce(document.getElementById("emailError"),"Enter a valid Gmail"); isValid=false;}
        if(!validatePhoneInstant()) isValid=false;
        const password=document.getElementById("password").value;
        if(!password){ showErrorOnce(document.getElementById("passwordError"),"Password is required"); isValid=false;}
        else if(password.length < 6){  
            showErrorOnce(document.getElementById("passwordError"), "Password must be at least 6 characters long"); 
            isValid = false;
        }
        const confirmPassword=document.getElementById("confirmPassword").value;
        if(!confirmPassword){ showErrorOnce(document.getElementById("confirmPasswordError"),"Confirmation password is required"); isValid=false;}
        if(password && confirmPassword && password!==confirmPassword){ showErrorOnce(document.getElementById("passwordError"),"Passwords do not match"); isValid=false;}
        const male=document.querySelector("input[value='Male']").checked;
        const female=document.querySelector("input[value='Female']").checked;
        if(!male && !female){ showErrorOnce(document.getElementById("genderError"),"Select your gender"); isValid=false;}
        if(!validateDOBInstant()) isValid=false;
        if(!document.getElementById("address").value.trim()){ showErrorOnce(document.getElementById("addressError"),"Address is required"); isValid=false;}
        if(!document.getElementById("role").value){ showErrorOnce(document.getElementById("roleError"),"Select your role"); isValid=false;}
        return isValid;
    }
</script>
</body>
</html>