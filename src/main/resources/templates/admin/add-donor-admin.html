<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Add Donor</title>
  <!-- Head -->
  <th:block th:replace="~{fragments/head :: head(${title})}"></th:block>

  <!-- Bootstrap Icons CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" th:href="@{/css/donor-admin.css}">
</head>
<body>
  <!-- Sidebar -->
  <div th:replace="fragments/sidebar :: sidebar(${active})"></div>

  <!-- Main Content -->
  <div id="content">
    <!-- Top nav -->
    <div th:replace="~{fragments/topnav :: topnav(${userName}, ${avatarUrl})}"></div>

    <!-- Page content -->
    <main class="container-fluid p-4">
      <!-- Header -->
      <div class="mb-4 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="bi bi-people-fill page-header-icon"></i>
          <div>
            <h2 class="mb-0 fw-bold" style="color: var(--primary-color);">Donor Management</h2>
            <p class="text-muted mb-0">
              <i class="bi bi-arrow-right-short"></i>Add new donor via admin
            </p>
          </div>
        </div>
      </div>

      <!-- ===== Check existing donor (same visual style as Add New Donor) ===== -->
      <div class="row justify-content-center">
        <div class="col-lg-9">
          <div class="card donor-form-card mb-4">
            <div class="card-header-custom text-white">
              <div class="d-flex align-items-center">
                <div class="card-header-icon me-3">
                  <i class="bi bi-search"></i>
                </div>
                <div class="flex-grow-1">
                  <h3 class="mb-1">Check Existing Donor</h3>
                  <p class="mb-0 opacity-75">
                    <i class="bi bi-info-circle me-1"></i>Search for an existing donor by email to schedule an appointment
                  </p>
                </div>
              </div>
            </div>

            <div class="card-body p-4" style="background-color: white;">
              <form th:action="@{/admin/donors/appointments/search}" method="post" class="row g-3">
                <div class="col-md-8">
                  <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-envelope-at-fill"></i></span>
                    <input type="email" name="email" class="form-control" placeholder="Enter donor email (exact match)" required>
                  </div>
                </div>
                <div class="col-md-4">
                  <button type="submit" class="btn btn-action w-100 h-100">
                    <i class="bi bi-search"></i> Find donor &amp; make appointment
                  </button>
                </div>
              </form>

              <!-- Error Message -->
              <div th:if="${searchError}" class="alert alert-danger d-flex align-items-center mt-3" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span th:text="${searchError}">No donor found with that email.</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== Add New Donor ===== -->
      <div class="row justify-content-center">
        <div class="col-lg-9">
          <div class="card donor-form-card">
            <div class="card-header-custom text-white">
              <div class="d-flex align-items-center">
                <div class="card-header-icon me-3">
                  <i class="bi bi-person-fill-add"></i>
                </div>
                <div class="flex-grow-1">
                  <h3 class="mb-1">
                    <i class="bi bi-clipboard2-pulse me-2"></i>Add New Donor
                  </h3>
                  <p class="mb-0 opacity-75">
                    <i class="bi bi-info-circle me-1"></i>Complete the form below to register a new donor
                  </p>
                </div>
              </div>
            </div>

            <div class="card-body p-4" style="background-color: white;">

              <!-- Hospital Info -->
              <div class="hospital-info mb-4">
                <i class="bi bi-hospital-fill me-2"></i>
                <strong>Hospital:</strong> <span th:text="${hospital.hospitalName}">Hospital</span>
                <i class="bi bi-check-circle-fill float-end"></i>
              </div>

              <form th:action="@{/admin/donors/add}"
                    th:object="${donor}"
                    method="post"
                    id="donorForm"
                    novalidate>

                <!-- Personal Information -->
                <div class="form-section">
                  <h5 class="section-title">
                    <i class="bi bi-person-vcard"></i>Personal Information
                  </h5>

                  <div class="row">
                    <!-- Username -->
                    <div class="col-md-6 mb-3">
                      <label for="username" class="form-label">
                        <i class="bi bi-person-badge"></i>Username <span class="required-asterisk">*</span>
                      </label>
                      <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-person-circle"></i></span>
                        <input type="text" th:field="*{username}" id="username" class="form-control"
                               th:classappend="${#fields.hasErrors('username')} ? 'is-invalid'"
                               placeholder="Enter username">
                      </div>
                      <div id="err-username" class="invalid-feedback"
                           th:classappend="${#fields.hasErrors('username')} ? 'show'"
                           data-default="Username is required.">
                        <span th:if="${#fields.hasErrors('username')}" th:errors="*{username}"></span>
                      </div>
                    </div>

                    <!-- Email -->
                    <div class="col-md-6 mb-3">
                      <label for="email" class="form-label">
                        <i class="bi bi-envelope-at"></i>Email Address <span class="required-asterisk">*</span>
                      </label>
                      <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-envelope-fill"></i></span>
                        <input type="email" th:field="*{email}" id="email" class="form-control"
                               th:classappend="${#fields.hasErrors('email')} ? 'is-invalid'"
                               placeholder="[email protected]">
                      </div>
                      <div id="err-email" class="invalid-feedback"
                           th:classappend="${#fields.hasErrors('email')} ? 'show'"
                           data-default="Email is required."
                           data-invalid="Please enter a valid email address.">
                        <span th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></span>
                      </div>
                    </div>
                  </div>

                  <!-- Password row -->
                  <div class="row">
                    <!-- Temporary Password (disabled visible + hidden real field) -->
                    <div class="col-md-12 mb-3">
                      <label for="passwordView" class="form-label">
                        <i class="bi bi-lock-fill"></i>Password
                      </label>
                      <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
                        <!-- Visible, disabled (not submitted) -->
                        <input type="password" id="passwordView" class="form-control" value="default123" disabled>
                        <!-- Hidden, actually submitted and bound to donor.password -->
                        <input type="hidden" th:field="*{password}" value="default123">
                      </div>
                      <div class="form-text text-muted">
                        The default password is <b>default123</b>.
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <!-- Phone -->
                    <div class="col-md-6 mb-3">
                      <label for="phone" class="form-label">
                        <i class="bi bi-telephone"></i>Phone Number <span class="required-asterisk">*</span>
                      </label>
                      <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-phone-vibrate"></i></span>

                        <!-- Enforce: starts with 09, total 9–13 digits -->
                        <input
                          type="text"
                          th:field="*{phone}"
                          id="phone"
                          class="form-control"
                          th:classappend="${#fields.hasErrors('phone')} ? 'is-invalid'"
                          placeholder="09XXXXXXXXX"
                          inputmode="numeric"
                          minlength="9"
                          maxlength="13"
                          pattern="^09\\d{7,11}$"
                          title="Phone must start with 09 and be 9–13 digits (numbers only)."
                          required
                        >
                      </div>

                      <div id="err-phone" class="invalid-feedback"
                           th:classappend="${#fields.hasErrors('phone')} ? 'show'"
                           data-default="Phone is required."
                           data-invalid="Phone must start with 09 and be 9–13 digits.">
                        <span th:if="${#fields.hasErrors('phone')}" th:errors="*{phone}"></span>
                      </div>

                      <div class="form-text text-muted">
                        Format: <b>09</b> followed by 7–11 digits (e.g., <code>091234567</code> or <code>0912345678901</code>).
                      </div>
                    </div>

                    <!-- DOB -->
                    <div class="col-md-6 mb-3">
                      <label for="dob" class="form-label">
                        <i class="bi bi-calendar-heart"></i>Date of Birth <span class="required-asterisk">*</span>
                      </label>
                      <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-calendar-event-fill"></i></span>
                        <input type="date" th:field="*{dateOfBirth}" id="dob" class="form-control"
                               th:classappend="${#fields.hasErrors('dateOfBirth')} ? 'is-invalid'">
                      </div>
                      <div id="err-dateOfBirth" class="invalid-feedback"
                           th:classappend="${#fields.hasErrors('dateOfBirth')} ? 'show'"
                           data-default="Date of birth is required."
                           data-underage="Donor must be at least 18 years old.">
                        <span th:if="${#fields.hasErrors('dateOfBirth')}" th:errors="*{dateOfBirth}"></span>
                      </div>
                    </div>
                  </div>

				<!-- Gender -->
				<div class="mb-3">
				  <label class="form-label">
				    <i class="bi bi-gender-ambiguous"></i>Gender <span class="required-asterisk">*</span>
				  </label>
				
				  <div class="d-flex gap-4">
				    <div class="form-check">
				      <input class="form-check-input"
				             type="radio"
				             th:field="*{gender}"
				             th:value="'Male'"
				             id="male"
				             required
				             th:classappend="${#fields.hasErrors('gender')} ? 'is-invalid'">
				      <label class="form-check-label" for="male">
				        <i class="bi bi-gender-male"></i> Male
				      </label>
				    </div>
				
				    <div class="form-check">
				      <input class="form-check-input"
				             type="radio"
				             th:field="*{gender}"
				             th:value="'Female'"
				             id="female"
				             required
				             th:classappend="${#fields.hasErrors('gender')} ? 'is-invalid'">
				      <label class="form-check-label" for="female">
				        <i class="bi bi-gender-female"></i> Female
				      </label>
				    </div>
				  </div>
				
				  <div id="err-gender"
				       class="invalid-feedback"
				       th:classappend="${#fields.hasErrors('gender')} ? ' d-block' : ''"
				       data-default="Gender is required.">
				    <span th:if="${#fields.hasErrors('gender')}" th:errors="*{gender}"></span>
				  </div>
				</div>
                <!-- Medical Information -->
                <div class="form-section">
                  <h5 class="section-title">
                    <i class="bi bi-heart-pulse-fill"></i>Medical Information
                  </h5>

                  <div class="row">
                    <div class="col-md-12 mb-3">
                      <label for="bloodType" class="form-label">
                        <i class="bi bi-droplet-half"></i>Blood Type <span class="required-asterisk">*</span>
                      </label>
                      <div class="input-group">
                        <span class="input-group-text">
                          <i class="bi bi-droplet-fill" style="color: var(--secondary-color);"></i>
                        </span>
                        <select th:field="*{bloodTypeId}" id="bloodType" class="form-select"
                                th:classappend="${#fields.hasErrors('bloodTypeId')} ? 'is-invalid'">
                          <option value="">-- Select Blood Type --</option>
                          <option th:each="bt : ${bloodTypes}" th:value="${bt.id}" th:text="${bt.bloodType}"></option>
                        </select>
                      </div>
                      <div id="err-bloodTypeId" class="invalid-feedback"
                           th:classappend="${#fields.hasErrors('bloodTypeId')} ? 'show'"
                           data-default="Blood type is required.">
                        <span th:if="${#fields.hasErrors('bloodTypeId')}" th:errors="*{bloodTypeId}"></span>
                      </div>
                    </div>

                    <div class="col-md-6">
                    </div>
                  </div>
                </div>

                <!-- Contact Information -->
                <div class="form-section">
                  <h5 class="section-title">
                    <i class="bi bi-geo-alt-fill"></i>Contact Information
                  </h5>

                  <div class="mb-3">
                    <label for="address" class="form-label">
                      <i class="bi bi-house-door"></i>Address <span class="required-asterisk">*</span>
                    </label>
                    <div class="input-group align-items-start">
                      <span class="input-group-text" style="border-radius: 8px 0 0 8px;">
                        <i class="bi bi-map"></i>
                      </span>
                      <textarea id="address" th:field="*{address}" rows="4" class="form-control"
                                th:classappend="${#fields.hasErrors('address')} ? 'is-invalid'"
                                placeholder="Enter complete address"></textarea>
                    </div>
                    <div id="err-address" class="invalid-feedback"
                         th:classappend="${#fields.hasErrors('address')} ? 'show'"
                         data-default="Address is required.">
                      <span th:if="${#fields.hasErrors('address')}" th:errors="*{address}"></span>
                    </div>
                  </div>
                </div>

                <!-- Submit -->
                <div class="d-flex justify-content-between align-items-center mt-4">
                  <small class="info-text">
                    <i class="bi bi-exclamation-circle-fill"></i>
                    Fields marked with <span class="required-asterisk">*</span> are required
                  </small>
                  <button type="submit" class="btn btn-submit">
                    <i class="bi bi-plus-circle-fill me-2"></i>Add Donor
                  </button>
                </div>

              </form>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script th:src="@{/js/dashboard.js}"></script>
  <script th:src="@{/js/add-donor-admin.js}"></script>
</body>
</html>
