<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <title th:text="${title}">Add Blood Request</title>
  <th:block th:replace="~{fragments/head :: head(${title})}"></th:block>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>
<div th:replace="~{fragments/sidebar :: sidebar(${active})}"></div>
<div id="content">
  <div th:replace="~{fragments/topnav :: topnav(${userName}, ${avatarUrl})}"></div>

  <main class="container-fluid p-4 d-flex justify-content-center">
    <div class="table-card w-100 mx-auto" style="max-width: 880px;">
      <div class="card-header-custom d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <div class="card-header-icon"><i class="bi bi-clipboard-plus"></i></div>
          <div>
            <h3 class="mb-0">Add Blood Request</h3>
            <small class="text-white-50">Create recipient blood request.</small>
          </div>
        </div>
        <a class="btn btn-action" th:href="@{/admin/recipients}">
          <i class="bi bi-arrow-left"></i> Back
        </a>
      </div>

      <div class="card-body p-4" style="background-color: white;">

        <!-- Hospital Info -->
        <div class="hospital-info mb-4">
          <i class="bi bi-hospital-fill me-2"></i>
          <strong>Hospital:</strong>
          <span th:if="${hospital != null}" th:text="${hospital.hospitalName}">Hospital Name</span>
          <span th:if="${hospital == null}">Select a hospital</span>
          <i class="bi bi-check-circle-fill float-end" th:if="${hospital != null}"></i>
        </div>

        <form th:action="@{/admin/recipients/add}"
              th:object="${form}"
              method="post"
              id="requestForm"
              novalidate>

          <!-- If no session hospital, allow selection -->
          <div class="form-section" th:if="${form.hospitalId == null}">
            <h5 class="section-title">
              <i class="bi bi-hospital"></i>Hospital
            </h5>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">
                  <i class="bi bi-h-circle"></i>Hospital <span class="required-asterisk">*</span>
                </label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-hospital"></i></span>
                  <select th:field="*{hospitalId}" class="form-select" id="hospitalId">
                    <option value="">-- Select Hospital --</option>
                    <option th:each="h : ${hospitals}" th:value="${h.id}" th:text="${h.hospitalName}"></option>
                  </select>
                </div>
                <div id="err-hospitalId" class="invalid-feedback" data-default="Hospital is required."></div>
              </div>
            </div>
          </div>
          <input type="hidden" th:if="${form.hospitalId != null}" th:field="*{hospitalId}"/>

          <!-- Personal Information -->
          <div class="form-section">
            <h5 class="section-title">
              <i class="bi bi-person-vcard"></i>Personal Information
            </h5>

            <div class="row">
              <!-- Username -->
              <div class="col-md-6 mb-3">
                <label for="name" class="form-label">
                  <i class="bi bi-person-badge"></i>Name <span class="required-asterisk">*</span>
                </label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-person-circle"></i></span>
                  <input type="text" th:field="*{name}" id="name" class="form-control" placeholder="Enter username">
                </div>
                <div id="err-name" class="invalid-feedback" data-default="Username is required."></div>
              </div>

              <!-- Email -->
              <div class="col-md-6 mb-3">
                <label for="email" class="form-label">
                  <i class="bi bi-envelope-at"></i>Email Address <span class="required-asterisk">*</span>
                </label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-envelope-fill"></i></span>
                  <input type="email" th:field="*{email}" id="email" class="form-control" placeholder="[email protected]">
                </div>
                <div id="err-email" class="invalid-feedback"
                     data-default="Email is required."
                     data-invalid="Please enter a valid email address."></div>
              </div>
            </div>

            <!-- Password (visible disabled + hidden field) -->
            <div class="row">
              <div class="col-md-12 mb-3">
                <label class="form-label">
                  <i class="bi bi-lock-fill"></i>Password <span class="required-asterisk">*</span>
                </label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
                  <input type="password" id="passwordView" class="form-control" value="default123" disabled>
                  <input type="hidden" th:field="*{password}" value="default123">
                </div>
                <div id="err-password" class="invalid-feedback" data-default="Password is required."></div>
                <div class="form-text text-muted">The default password is <b>default123</b>.</div>
              </div>
            </div>

            <div class="row">
              <!-- Phone -->
              <div class="col-md-6 mb-3">
                <label for="phone" class="form-label">
                  <i class="bi bi-telephone"></i>Phone Number <span class="required-asterisk">*</span>
                </label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-phone-vibrate"></i></span>
                  <input type="text"
                         th:field="*{phone}"
                         id="phone"
                         class="form-control"
                         placeholder="09XXXXXXXXX"
                         inputmode="numeric"
                         minlength="9"
                         maxlength="13"
                         pattern="^09\\d{7,11}$"
                         title="Phone must start with 09 and be 9–13 digits (numbers only).">
                </div>
                <div id="err-phone" class="invalid-feedback"
                     data-default="Phone is required."
                     data-invalid="Phone must start with 09 and be 9–13 digits."></div>
                <div class="form-text text-muted">
                  Format: <b>09</b> followed by 7–11 digits (e.g., <code>091234567</code> or <code>0912345678901</code>).
                </div>
              </div>

              <!-- DOB -->
              <div class="col-md-6 mb-3">
                <label for="dob" class="form-label">
                  <i class="bi bi-calendar-heart"></i>Date of Birth <span class="required-asterisk">*</span>
                </label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-calendar-event-fill"></i></span>
                  <input type="date" th:field="*{dob}" id="dob" class="form-control">
                </div>
                <div id="err-dob" class="invalid-feedback" data-default="Date of birth is required."></div>
              </div>
            </div>

            <!-- Gender (required) -->
            <div class="mb-3">
              <label class="form-label">
                <i class="bi bi-gender-ambiguous"></i>Gender <span class="required-asterisk">*</span>
              </label>
              <div class="d-flex gap-4">
                <div class="form-check">
                  <input class="form-check-input" type="radio" th:field="*{gender}" id="gMale" value="Male">
                  <label class="form-check-label" for="gMale"><i class="bi bi-gender-male"></i> Male</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" th:field="*{gender}" id="gFemale" value="Female">
                  <label class="form-check-label" for="gFemale"><i class="bi bi-gender-female"></i> Female</label>
                </div>
              </div>
              <div id="err-gender" class="invalid-feedback" data-default="Gender is required."></div>
            </div>
          </div>

          <!-- Medical Information -->
          <div class="form-section">
            <h5 class="section-title">
              <i class="bi bi-heart-pulse-fill"></i>Medical Information
            </h5>

            <div class="row">
              <!-- Blood Type -->
              <div class="col-md-6 mb-3">
                <label for="bloodTypeId" class="form-label">
                  <i class="bi bi-droplet-half"></i>Blood Type <span class="required-asterisk">*</span>
                </label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-droplet-fill"></i></span>
                  <select th:field="*{bloodTypeId}" id="bloodTypeId" class="form-select">
                    <option value="">Select Blood Type</option>
                    <option th:each="bt : ${bloodTypes}" th:value="${bt.id}" th:text="${bt.bloodType}"></option>
                  </select>
                </div>
                <div id="err-bloodTypeId" class="invalid-feedback" data-default="Blood type is required."></div>
              </div>

              <!-- Quantity -->
              <div class="col-md-6 mb-3">
                <label for="quantity" class="form-label">
                  <i class="bi bi-box-seam"></i>Quantity (units) <span class="required-asterisk">*</span>
                </label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-123"></i></span>
                  <input type="number" min="1" th:field="*{quantity}" id="quantity" class="form-control" placeholder="e.g., 2">
                </div>
                <div id="err-quantity" class="invalid-feedback" data-default="Quantity must be at least 1."></div>
              </div>

              <!-- Urgency -->
              <div class="col-md-6 mb-3">
                <label for="urgency" class="form-label">
                  <i class="bi bi-speedometer2"></i>Urgency <span class="required-asterisk">*</span>
                </label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-lightning-charge"></i></span>
                  <select th:field="*{urgency}" id="urgency" class="form-select">
                    <option value="">Select Urgency</option>
                    <option th:each="u : ${T(com.grppj.donateblood.model.Urgency).values()}"
                            th:value="${u}" th:text="${u}"></option>
                  </select>
                </div>
                <div id="err-urgency" class="invalid-feedback" data-default="Urgency is required."></div>
              </div>

              <!-- Required Date -->
              <div class="col-md-6 mb-3">
                <label for="requiredDate" class="form-label">
                  <i class="bi bi-calendar-check"></i>Required Date <span class="required-asterisk">*</span>
                </label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-calendar-event-fill"></i></span>
                  <input type="date"
                         th:field="*{requiredDate}"
                         id="requiredDate"
                         class="form-control"
                         th:attr="min=${today}"
                         placeholder="Select required date">
                </div>
                <div id="err-requiredDate" class="invalid-feedback" data-default="Required date is required."></div>
              </div>
            </div><!-- /.row -->
          </div><!-- /.form-section -->

          <!-- Contact Information -->
          <div class="form-section">
            <h5 class="section-title">
              <i class="bi bi-geo-alt-fill"></i>Contact Information
            </h5>

            <div class="mb-3">
              <label for="address" class="form-label">
                <i class="bi bi-house-door"></i>Address <span class="required-asterisk">*</span>
              </label>
              <div class="input-group align-items-start">
                <span class="input-group-text" style="border-radius: 8px 0 0 8px;">
                  <i class="bi bi-map"></i>
                </span>
                <textarea id="address" th:field="*{address}" rows="4" class="form-control"
                          placeholder="Enter complete address"></textarea>
              </div>
              <div id="err-address" class="invalid-feedback" data-default="Address is required."></div>
            </div>
          </div>

          <!-- Submit -->
          <div class="d-flex justify-content-between align-items-center mt-4">
            <small class="info-text">
              <i class="bi bi-exclamation-circle-fill"></i>
              Fields marked with <span class="required-asterisk">*</span> are required
            </small>
            <button type="submit" class="btn btn-submit">
              <i class="bi bi-plus-circle-fill me-2"></i>Add Blood Request
            </button>
          </div>

        </form>
      </div>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
  const form = document.getElementById('requestForm');
  const get  = (name) => form.querySelector(`[name="${name}"]`);
  const setErr = (id, show, msg) => {
    const el = document.getElementById(id); if (!el) return;
    el.classList.toggle('show', !!show);
    if (msg) el.textContent = msg;
    if (!msg && el.dataset && el.dataset.default && show) el.textContent = el.dataset.default;
  };
  const markBad = (ctrl, bad) => { if (ctrl) ctrl.classList.toggle('is-invalid', !!bad); };

  // keep date min synced to today, but don't validate yet
  const rqd = get('requiredDate');
  if (rqd) rqd.setAttribute('min', new Date().toISOString().split('T')[0]);

  form.addEventListener('submit', (e) => {
    let bad = false;

    // Hospital (only if selector is visible)
    const hospSel = document.getElementById('hospitalId');
    if (hospSel && !hospSel.disabled) {
      const b = !hospSel.value;
      markBad(hospSel, b); setErr('err-hospitalId', b); bad ||= b;
    }

    // Username
    const name = get('name');
    let b = !name.value.trim(); markBad(name, b); setErr('err-name', b); bad ||= b;

    // Email
    const email = get('email');
    b = !email.value.trim();
    if (!b && !email.checkValidity()) { b = true; setErr('err-email', true, document.getElementById('err-email').dataset.invalid); }
    else setErr('err-email', b);
    markBad(email, b); bad ||= b;

    // Password (hidden actual field)
    const pwd = get('password');
    b = !pwd.value.trim(); setErr('err-password', b); bad ||= b;

    // DOB
    const dob = get('dob');
    b = !dob.value; markBad(dob, b); setErr('err-dob', b); bad ||= b;

    // Phone
    const phone = get('phone');
    const phoneRe = /^09\d{7,11}$/;
    b = !phone.value.trim();
    if (!b && !phoneRe.test(phone.value.trim())) {
      b = true; setErr('err-phone', true, document.getElementById('err-phone').dataset.invalid);
    } else setErr('err-phone', b);
    markBad(phone, b); bad ||= b;

    // Gender (radio group)
    const genderRadios = form.querySelectorAll('input[name="gender"]');
    let genderBad = true; genderRadios.forEach(r => { if (r.checked) genderBad = false; });
    setErr('err-gender', genderBad); bad ||= genderBad;
    genderRadios.forEach(r => r.classList.toggle('is-invalid', genderBad));

    // Blood type
    const bt = get('bloodTypeId');
    b = !bt.value; markBad(bt, b); setErr('err-bloodTypeId', b); bad ||= b;

    // Quantity
    const qty = get('quantity');
    const qv = parseInt(qty.value || '0', 10);
    b = isNaN(qv) || qv < 1; markBad(qty, b); setErr('err-quantity', b); bad ||= b;

    // Urgency
    const urg = get('urgency');
    b = !urg.value; markBad(urg, b); setErr('err-urgency', b); bad ||= b;

    // Required Date (must be today or later)
    if (rqd) {
      const todayStr = rqd.min || new Date().toISOString().split('T')[0];
      let rb = !rqd.value || rqd.value < todayStr;
      if (rb && rqd.value && rqd.value < todayStr) {
        setErr('err-requiredDate', true, 'Required date cannot be in the past.');
      } else {
        setErr('err-requiredDate', rb);
      }
      markBad(rqd, rb); bad ||= rb;
    }

    // Address
    const addr = get('address');
    b = !addr.value.trim(); markBad(addr, b); setErr('err-address', b); bad ||= b;

    if (bad) { e.preventDefault(); e.stopPropagation(); (form.querySelector('.is-invalid') || form).focus(); }
  });

  // Clear error on interaction
  form.querySelectorAll('input,select,textarea').forEach(el=>{
    el.addEventListener('input', ()=>{ el.classList.remove('is-invalid'); });
    el.addEventListener('change', ()=>{ el.classList.remove('is-invalid'); });
  });
  form.querySelectorAll('input[name="gender"]').forEach(r=>{
    r.addEventListener('change', ()=>{
      document.getElementById('err-gender')?.classList.remove('show');
      form.querySelectorAll('input[name="gender"]').forEach(x=>x.classList.remove('is-invalid'));
    });
  });
})();
</script>
</body>
</html>
