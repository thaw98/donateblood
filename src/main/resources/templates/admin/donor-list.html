<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>All Donors</title>
  <!-- Head -->
  <th:block th:replace="fragments/head :: head(${title})"></th:block>

  <!-- Bootstrap Icons CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <link rel="stylesheet" th:href="@{/css/donor-admin.css}">
</head>
<body>
  <!-- Sidebar -->
  <div th:replace="fragments/sidebar :: sidebar(${active})"></div>

  <!-- Main Content -->
  <div id="content">
    <!-- Top nav -->
    <div th:replace="~{fragments/topnav :: topnav(${userName}, ${avatarUrl})}"></div>

    <!-- Page content -->
    <main class="container-fluid p-4">

      <!-- Page Header -->
      <div class="mb-4 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="bi bi-people-fill page-header-icon"></i>
          <div>
            <h2 class="mb-0 fw-bold" style="color: var(--primary-color);">All Donors</h2>
            <p class="text-muted mb-0">
              <i class="bi bi-arrow-right-short"></i>Manage and filter donor records
            </p>
          </div>
        </div>
      </div>

      <!-- Filter Toolbar -->
      <div class="filter-toolbar">
        <div class="row align-items-end g-3">
          <!-- Search Input -->
          <div class="col-lg-4 col-md-6">
            <label class="form-label fw-bold mb-2" style="color: var(--dark-color);">
              <i class="bi bi-search text-info"></i> Search Donor
            </label>
            <div class="search-input-wrapper">
              <input id="q"
                     type="search"
                     class="form-control"
                     placeholder="Search name or email…"
                     autocomplete="off">
            </div>
          </div>

          <!-- Blood Type Filter -->
          <div class="col-lg-2 col-md-6">
            <label class="form-label fw-bold mb-2" style="color: var(--dark-color);">
              <i class="bi bi-droplet-fill text-danger"></i> Blood Type
            </label>
            <select id="btFilter" class="form-select">
              <option value="">All Types</option>
              <option th:each="e : ${bloodTypeMap}"
                      th:value="${e.key}"
                      th:text="${e.value}">
              </option>
            </select>
          </div>

          <!-- Status Filter -->
          <div class="col-lg-2 col-md-6">
            <label class="form-label fw-bold mb-2" style="color: var(--dark-color);">
              <i class="bi bi-activity text-info"></i> Status
            </label>
            <select id="statusFilter" class="form-select">
              <option value="">All Statuses</option>
              <option value="available">Available</option>
              <option value="used">Used</option>
            </select>
          </div>

          <!-- Clear Button -->
          <div class="col-lg-2 col-md-6">
            <button type="button" id="clearFilters" class="btn btn-clear w-100">
              <i class="bi bi-x-circle me-1"></i> Clear Filters
            </button>
          </div>

          <!-- Match Count -->
          <div class="col-lg-2 col-md-6 text-end">
            <span id="matchCount" class="match-count"></span>
          </div>
        </div>
      </div>

      <!-- Table Card -->
      <div class="table-card">
        <div class="table-card-header">
          <i class="bi bi-table"></i>
          <span>Donor Records</span>
        </div>

        <div class="table-responsive">
          <table id="donorTable" class="table donor-table">
            <thead>
              <tr>
                <th><i class="bi bi-hash"></i>No.</th>
                <th><i class="bi bi-person-badge"></i>Name</th>
                <th><i class="bi bi-droplet-fill"></i>Blood Type</th>
                <th><i class="bi bi-calendar-event"></i>Date of Birth</th>
                <th><i class="bi bi-envelope"></i>Email</th>
                <th><i class="bi bi-telephone"></i>Phone</th>
                <th><i class="bi bi-gender-ambiguous"></i>Gender</th>
                <th><i class="bi bi-geo-alt"></i>Address</th>
                <th><i class="bi bi-list-ol"></i>Total Donations</th>
                <th><i class="bi bi-clock-history"></i>History</th>
                <th><i class="bi bi-pencil-square"></i>Action</th>
              </tr>
            </thead>
            <tbody>
			<tr th:each="d, no : ${donorList}"
			    th:data-name="${d.username}"
			    th:data-email="${d.email}"
			    th:data-btid="${d.bloodTypeId}"
			    th:data-bt="${d.bloodTypeId != null ? bloodTypeMap[d.bloodTypeId] : null}"
			    th:data-total="${totalDonations[d.id] != null ? totalDonations[d.id] : 0}">

                <td>
                  <span class="row-number" th:text="${no.count}"></span>
                </td>
                <td>
                  <strong th:text="${d.username}"></strong>
                </td>
                <td>
                  <span class="blood-type-badge"
                        th:text="${d.bloodTypeId != null ? bloodTypeMap[d.bloodTypeId] : 'Unknown'}"></span>
                </td>
                <td th:text="${d.dateOfBirth != null ? #temporals.format(d.dateOfBirth, 'dd-MM-yyyy') : ''}"></td>
                <td>
                  <i class="bi bi-envelope-fill text-muted me-1"></i>
                  <span th:text="${d.email}"></span>
                </td>
                <td>
                  <i class="bi bi-phone-vibrate text-muted me-1"></i>
                  <span th:text="${d.phone}"></span>
                </td>
                <td>
                  <i th:classappend="${d.gender == 'Male' ? 'bi bi-gender-male text-info' : 'bi bi-gender-female text-danger'}"
                     class="me-1"></i>
                  <span th:text="${d.gender}"></span>
                </td>
                <td th:text="${d.address}"></td>
                <td>
                  <span th:text="${totalDonations[d.id] != null ? totalDonations[d.id] : 0}">0</span>
                </td>
                <td>
                  <a th:href="@{/admin/donors/history/{id}(id=${d.id})}" class="btn btn-sm btn-info">
                    <i class="bi bi-clock-history"></i> View
                  </a>
                </td>
                <td>
                  <a th:href="@{/admin/donors/edit/{id}(id=${d.id})}" class="btn-action">
                    <i class="bi bi-pencil-fill"></i>Edit
                  </a>
                </td>
              </tr>

              <tr id="noRows" style="display:none;">
                <td colspan="11" class="no-results">
                  <i class="bi bi-inbox"></i>
                  <div>No matching donors found</div>
                  <small class="text-muted">Try adjusting your search filters</small>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination (client-side) with FIRST / LAST -->
        <nav aria-label="Donor pagination" class="d-flex justify-content-center p-3">
          <ul id="pager" class="pagination mb-0"
              style="
                --bs-pagination-color: var(--secondary-color);
                --bs-pagination-hover-color: var(--secondary-color);
                --bs-pagination-focus-box-shadow: 0 0 0 .25rem rgba(198,40,40,.25);
                --bs-pagination-active-bg: var(--secondary-color);
                --bs-pagination-active-border-color: var(--secondary-color);
              ">
            <!-- JS injects First / Prev / pages / Next / Last -->
          </ul>
        </nav>
      </div>

    </main>
  </div>

  <!-- JS loaded directly -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script th:src="@{/js/dashboard.js}"></script>

  <script>
  (function () {
    const PAGE_SIZE = 5;

    const $  = (s, c=document) => c.querySelector(s);
    const $$ = (s, c=document) => Array.from(c.querySelectorAll(s));

    const qInput   = $('#q');                 // search box
    const btSelect = $('#btFilter');          // blood type dropdown
    const stSelect = $('#statusFilter');      // status dropdown
    const clearBtn = $('#clearFilters');      // clear button
    const countEl  = $('#matchCount');        // "Showing X–Y of Z"
    const noRows   = $('#noRows');            // "No matching donors" row
    const pager    = $('#pager');
    $$('#donorTable tbody tr').forEach(tr => {
    	  if (tr.id === 'noRows') return;
    	  const total = parseInt(tr.dataset.total || '0', 10);
    	  if (total === 0) tr.remove();
    	});
    // all data rows in tbody (skip "noRows")
    const allRows = $$('#donorTable tbody tr').filter(tr => tr.id !== 'noRows');

    // if you later add data-status on rows, this enables the status filter
    const hasStatusData = allRows.some(r => (r.dataset.status || '').trim().length > 0);

    const normalize = s => (s || '').toString().trim().toLowerCase();

    // state
    let filteredRows = allRows.slice();
    let currentPage  = 1;

    const totalPages = () => Math.max(1, Math.ceil(filteredRows.length / PAGE_SIZE));

    function debounce(fn, ms) {
      let t; return function () { clearTimeout(t); t = setTimeout(() => fn.apply(this, arguments), ms); };
    }

    function matches(row, q, bt, st) {
      const name  = normalize(row.dataset.name);
      const email = normalize(row.dataset.email);
      const okSearch = !q || (name + ' ' + email).includes(q);

      const rowBtId = (row.dataset.btid || '').toString();
      const okBt = !bt || rowBtId === bt;

      const rowSt = normalize(row.dataset.status);
      const okSt = !st || !hasStatusData || rowSt === st;

      return okSearch && okBt && okSt;
    }

    function pageItem(label, enabled, targetPage, active=false, ariaLabel) {
      const li = document.createElement('li');
      li.className = 'page-item' + (enabled ? '' : ' disabled') + (active ? ' active' : '');
      const a = document.createElement('a');
      a.className = 'page-link';
      a.href = '#';
      a.textContent = label;
      if (ariaLabel) a.setAttribute('aria-label', ariaLabel);
      a.addEventListener('click', function(e){
        e.preventDefault();
        if (!enabled) return;
        currentPage = targetPage;
        render();
      });
      li.appendChild(a);
      return li;
    }

    function ellipsis() {
      const li = document.createElement('li');
      li.className = 'page-item disabled';
      li.innerHTML = '<span class="page-link">…</span>';
      return li;
    }

    function buildPager() {
      const pages = totalPages();
      pager.innerHTML = '';

      // FIRST (first page)
      pager.appendChild(pageItem('First', currentPage > 1, 1, false, 'Go to first page'));

      // Prev
      pager.appendChild(pageItem('Prev', currentPage > 1, Math.max(1, currentPage - 1), false, 'Previous page'));

      // numbers (compact window)
      const maxButtons = 7;
      let start = 1, end = pages;

      if (pages > maxButtons) {
        const win = 3; // around current
        start = Math.max(1, currentPage - win);
        end   = Math.min(pages, currentPage + win);

        if (start <= 2) { start = 1; end = Math.min(pages, 1 + 2*win); }
        if (end >= pages - 1) { end = pages; start = Math.max(1, pages - 2*win); }
      }

      if (start > 1) {
        pager.appendChild(pageItem('1', true, 1, currentPage === 1));
        if (start > 2) pager.appendChild(ellipsis());
      }

      for (let p = start; p <= end; p++) {
        pager.appendChild(pageItem(String(p), true, p, currentPage === p));
      }

      if (end < pages) {
        if (end < pages - 1) pager.appendChild(ellipsis());
        pager.appendChild(pageItem(String(pages), true, pages, currentPage === pages));
      }

      // Next
      pager.appendChild(pageItem('Next', currentPage < pages, Math.min(pages, currentPage + 1), false, 'Next page'));

      // LAST (last page)
      pager.appendChild(pageItem('Last', currentPage < pages, pages, false, 'Go to last page'));
    }

    function render() {
      // hide all rows
      allRows.forEach(r => r.style.display = 'none');

      // slice for current page
      const startIdx = (currentPage - 1) * PAGE_SIZE;
      const endIdx   = Math.min(startIdx + PAGE_SIZE, filteredRows.length);
      for (let i = startIdx; i < endIdx; i++) filteredRows[i].style.display = '';

      // counts
      if (countEl) {
        const total = filteredRows.length;
        if (!total) {
          countEl.textContent = '';
          countEl.style.display = 'none';
        } else {
          countEl.textContent = `Showing ${total ? (startIdx + 1) : 0}-${endIdx} of ${total}`;
          countEl.style.display = 'inline-block';
        }
      }

      // empty state
      if (noRows) noRows.style.display = filteredRows.length === 0 ? '' : 'none';

      // pager
      buildPager();
      pager.parentElement.style.display = totalPages() > 1 ? '' : 'none';
    }

    function applyFilters() {
      const q  = normalize(qInput?.value);
      const bt = btSelect?.value || '';
      const st = normalize(stSelect?.value || '');

      filteredRows = allRows.filter(tr => matches(tr, q, bt, st));
      currentPage  = 1; // reset to first page after filtering
      render();
    }

    const update = debounce(applyFilters, 120);

    // events
    if (qInput)   qInput.addEventListener('input', update);
    if (btSelect) btSelect.addEventListener('change', applyFilters);
    if (stSelect) stSelect.addEventListener('change', applyFilters);
    if (clearBtn) clearBtn.addEventListener('click', () => {
      if (qInput)   qInput.value = '';
      if (btSelect) btSelect.value = '';
      if (stSelect) stSelect.value = '';
      applyFilters();
      if (qInput) qInput.focus();
    });

    // initial run
    applyFilters();
  })();
  </script>

</body>
</html>
